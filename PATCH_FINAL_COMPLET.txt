# =================================================================================
# PATCH COMPLET - Repararea TUTUROR problemelor
# =================================================================================

# =================================================================================
# PROBLEMA 1: TypeError Ã®n base_character.py
# =================================================================================

GÄ‚SEÈ˜TE Ã®n base_character.py (linia ~163):

    def setup_animators(self, layers):

ÃNLOCUIEÈ˜TE CU:

    def setup_animators(self, layers, dpi_scaler=None):  # â­ AdÄƒugat dpi_scaler!


APOI GÄ‚SEÈ˜TE Ã®n aceeaÈ™i metodÄƒ (linia ~175):

            animator = animator_class(self, layers)

ÃNLOCUIEÈ˜TE CU:

            animator = animator_class(self, layers, dpi_scaler)  # â­ PaseazÄƒ dpi_scaler!


# =================================================================================
# PROBLEMA 2: Gaze Tracking NU scaleazÄƒ corect (main_app.py linia ~5366)
# =================================================================================

GÄ‚SEÈ˜TE Ã®n main_app.py (liniile 5366-5372):

                if scene_config:
                    scale = scene_config.get("scale", 0.3)
                    scaled_pixmap = original_pixmap.scaled(
                        int(original_pixmap.width() * scale),
                        int(original_pixmap.height() * scale),
                        Qt.AspectRatioMode.KeepAspectRatio,
                        Qt.TransformationMode.SmoothTransformation
                    )

ÃNLOCUIEÈ˜TE CU:

                if scene_config:
                    # â­ SCALARE SCALE PENTRU DPI
                    scale_raw = scene_config.get("scale", 0.3)
                    scale = scale_raw / self.dpi_scaler.scale_factor
                    
                    # â­ FOLOSEÈ˜TE round() ÃN LOC DE int()
                    scaled_pixmap = original_pixmap.scaled(
                        round(original_pixmap.width() * scale),
                        round(original_pixmap.height() * scale),
                        Qt.AspectRatioMode.KeepAspectRatio,
                        Qt.TransformationMode.SmoothTransformation
                    )
                    
                    # â­ SALVEAZÄ‚ PIXMAP-UL ORIGINAL pentru viitoare rescale-uri
                    target_layer.original_pixmap = original_pixmap


# =================================================================================
# PROBLEMA 3: Semafor - widget-urile trebuie DEASUPRA fundalului
# =================================================================================

GÄ‚SEÈ˜TE Ã®n main_app.py (dupÄƒ linia ~1619, dupÄƒ print-ul cu semafor):

        print(f"ğŸ” [SEMAFOR] Fundal scalat de la...")
        
        light_diameter = self.dpi_scaler.scaled(55)

ADAUGÄ‚ IMEDIAT DUPÄ‚ print() È™i ÃNAINTE de light_diameter:

        # â­ RIDICÄ‚ FUNDALUL pentru a-l pune sub widget-uri
        self.semafor_bg_label.lower()  # Pune fundalul JOS
        print(f"ğŸ” [SEMAFOR] Background label lowered pentru z-order corect")


APOI GÄ‚SEÈ˜TE (linia ~1657):

        self.clepsidra_container.hide()
        self.semafor_container.hide()
        self.semafor_container.raise_()

ÃNLOCUIEÈ˜TE CU:

        self.clepsidra_container.hide()
        
        # â­ RIDICÄ‚ WIDGET-URILE DEASUPRA FUNDALULUI
        self.semafor_rosu_widget.raise_()
        self.semafor_verde_widget.raise_()
        self.clepsidra_container.raise_()
        
        self.semafor_container.hide()
        self.semafor_container.raise_()
        
        print(f"ğŸ” [SEMAFOR] Widgets raised - z-order corect (deasupra fundalului)")


# =================================================================================
# PROBLEMA 4: Ochii stau deschisi la Ã®nceput (emotional state "sleeping")
# =================================================================================

Asta e OK - e din cauza cÄƒ EmotionAnimator seteazÄƒ "sleeping" dar trebuie sÄƒ verifici
dacÄƒ expresia "sleeping" are ochi Ã®nchiÈ™i Ã®n config.json:

"sleeping": {
    "ochi": "cap/ochi/ochi_inchisi_centru.png",  â­ VerificÄƒ cÄƒ existÄƒ!
    ...
}


# =================================================================================
# PROBLEMA 5: Personajele dispar cÃ¢nd schimbi scena
# =================================================================================

Asta e probabil din cauza cÄƒ poziÈ›iile din alte scene nu sunt scalate.
VerificÄƒ Ã®n config.json:

"scene_configs": {
    "scoala": {
        "scale": 0.3,
        "pos": [150, 550]  â­ Aceste poziÈ›ii vor fi scalate automat de cod
    }
}

DacÄƒ problema persistÄƒ, trebuie sÄƒ verific metoda care schimbÄƒ scena.


# =================================================================================
# REZUMAT - Ce sÄƒ faci:
# =================================================================================

1. âœ… ModificÄƒ base_character.py (2 locuri):
   - Linia ~163: adaugÄƒ parametru dpi_scaler=None
   - Linia ~175: paseazÄƒ dpi_scaler la animator

2. âœ… ModificÄƒ main_app.py - Gaze Tracking (linia ~5366):
   - ScaleazÄƒ scale cu DPI
   - FoloseÈ™te round() Ã®n loc de int()
   - SalveazÄƒ original_pixmap

3. âœ… ModificÄƒ main_app.py - Semafor Z-order (2 locuri):
   - DupÄƒ linia ~1619: adaugÄƒ self.semafor_bg_label.lower()
   - La linia ~1657: adaugÄƒ .raise() pentru fiecare widget

4. âœ… VerificÄƒ config.json - expresia "sleeping" are ochi Ã®nchiÈ™i


# =================================================================================
# TESTARE
# =================================================================================

DupÄƒ modificÄƒri:
1. È˜terge config.json
2. RuleazÄƒ aplicaÈ›ia
3. VerificÄƒ:
   - âœ… Ochii rÄƒmÃ¢n aliniaÈ›i cÃ¢nd vorbeÈ™te
   - âœ… Semafor-ul aratÄƒ corect (cercuri Ã®n gÄƒuri)
   - âœ… Ochii sunt Ã®nchiÈ™i la Ã®nceput
   - âœ… Personajele nu dispar cÃ¢nd schimbi scena

DacÄƒ mai sunt probleme, trimite-mi logurile! ğŸš€
